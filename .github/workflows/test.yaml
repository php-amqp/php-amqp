name: Test

on:
  push:
  pull_request:
    types: [ opened, synchronize, reopened ]

env:
  TEST_TIMEOUT: 120
  CFLAGS: -g -D_FORTIFY_SOURCE=2 -fstack-protector-strong -Wall -Werror
  MAKEFLAGS: -j4

jobs:
  dedup:
    name: Prevent duplicate builds
    continue-on-error: true
    runs-on: ubuntu-22.04
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5.3.0
        with:
          skip_after_successful_duplicate: 'true'
          cancel_others: 'true'
          concurrent_skipping: 'same_content_newer'

  checkstyle:
    name: Check C formatting
    runs-on: ubuntu-22.04
    needs: dedup
    if: needs.dedup.outputs.should_skip != 'true'

    steps:
      - name: Install clang-format
        uses: myci-actions/add-deb-repo@11
        with:
          repo: "deb https://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main"
          repo-name: llvm
          keys-asc: https://apt.llvm.org/llvm-snapshot.gpg.key
          install: clang-format-17

      - name: Checkout
        uses: actions/checkout@v3.5.3

      - name: Check style
        run: ./infra/tools/pamqp-format-check

  stubs:
    name: Check stubs php-${{ matrix.php-version }}
    runs-on: ubuntu-22.04
    needs: dedup
    if: needs.dedup.outputs.should_skip != 'true'

    strategy:
      fail-fast: false
      matrix:
        php-version: [ "8.3", "8.2", "8.1", "8.0", "7.4" ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3.5.3

      - name: Install packages
        uses: awalsh128/cache-apt-pkgs-action@v1.3.0
        with:
          packages: cmake valgrind

      - name: Setup PHP
        uses: shivammathur/setup-php@2.25.5
        with:
          php-version: ${{ matrix.php-version }}
          extensions: json
          coverage: none
        env:
          debug: true

      - name: Check stubs
        run: ./infra/tools/pamqp-stubs-lint

      - name: Build librabbitmq
        run: ./infra/tools/pamqp-install-librabbitmq master

      - name: Build PHP extension
        run: phpize && ./configure && make

      - name: Validate stubs
        run: ./infra/tools/pamqp-stubs-validate

      - name: Check stub coding style
        run: ./infra/tools/pamqp-stubs-format-check

      - name: Validate argument parsing
        run: ./infra/tools/pamqp-php-cli-deterministic -d extension=modules/amqp.so ./infra/tools/pamqp-arguments-validate
        if: matrix.php-version == '8.2' || matrix.php-version == '8.3'

  test:
    name: ${{ matrix.test-php-args == '-m' && 'Memtest' || 'Test' }} php-${{ matrix.php-version }}${{ matrix.php-thread-safe && '-ts' || '-nts' }} librabbitmq-${{ matrix.librabbitmq-version }} ${{ matrix.compiler }}
    # librabbitmq < 0.11 needs older OpenSSL version
    runs-on: ${{ (matrix.librabbitmq-version == '0.10.0' || matrix.librabbitmq-version == '0.9.0' || matrix.librabbitmq-version == '0.8.0') && 'ubuntu-20.04' || 'ubuntu-22.04' }}
    needs: dedup
    if: needs.dedup.outputs.should_skip != 'true'

    env:
      CC: ${{ matrix.compiler }}
      TEST_PHP_ARGS: -j4 ${{ matrix.test-php-args }}
      PHP_AMQP_HOST: localhost
      PHP_AMQP_SSL_HOST: rabbitmq.example.org
      VALGRIND_OPTS: "--suppressions=infra/tools/valgrind-suppressions"

    strategy:
      fail-fast: false
      matrix:
        php-version: [ '8.3', '8.2', '8.1', '8.0', '7.4' ]
        php-thread-safe: [ true, false ]
        librabbitmq-version: [ 'master', '0.13.0', '0.12.0', '0.11.0', '0.10.0', '0.9.0', '0.8.0' ]
        compiler: [gcc, clang]
        include:
          - php-version: '8.3'
            php-thread-safe: true
            librabbitmq-version: 'master'
            test-php-args: '-m'
            compiler: clang

          - php-version: '8.3'
            php-thread-safe: true
            librabbitmq-version: '0.8.0'
            test-php-args: '-m'
            compiler: gcc

          - php-version: '8.2'
            php-thread-safe: false
            librabbitmq-version: 'master'
            test-php-args: '-m'
            compiler: clang

          - php-version: '8.2'
            php-thread-safe: false
            librabbitmq-version: '0.8.0'
            test-php-args: '-m'
            compiler: gcc

          - php-version: '8.1'
            php-thread-safe: true
            librabbitmq-version: 'master'
            test-php-args: '-m'
            compiler: clang

          - php-version: '8.1'
            php-thread-safe: true
            librabbitmq-version: '0.8.0'
            test-php-args: '-m'
            compiler: gcc

          - php-version: '8.0'
            php-thread-safe: true
            librabbitmq-version: 'master'
            test-php-args: '-m'
            compiler: clang

          - php-version: '8.0'
            php-thread-safe: true
            librabbitmq-version: '0.8.0'
            test-php-args: '-m'
            compiler: gcc

          - php-version: '7.4'
            php-thread-safe: true
            librabbitmq-version: 'master'
            test-php-args: '-m'
            compiler: clang

          - php-version: '7.4'
            php-thread-safe: true
            librabbitmq-version: '0.8.0'
            test-php-args: '-m'
            compiler: gcc

    steps:
      - name: Checkout
        uses: actions/checkout@v3.5.3

      - name: Configure hostnames
        run: sudo echo "127.0.0.1 ${{ env.PHP_AMQP_SSL_HOST }}" | sudo tee -a /etc/hosts

      - name: Generate test certificates
        run: docker compose up ca

      - name: Start RabbitMQ
        run: docker compose up -d rabbitmq

      - name: Install packages
        uses: awalsh128/cache-apt-pkgs-action@v1.3.0
        with:
          packages: cmake valgrind ${{ matrix.compiler }}
          version: ${{ (matrix.librabbitmq-version == '0.10.0' || matrix.librabbitmq-version == '0.9.0' || matrix.librabbitmq-version == '0.8.0') && 'ubuntu-20.04' || 'ubuntu-22.04' }}

      - name: Setup PHP
        uses: shivammathur/setup-php@2.25.5
        with:
          php-version: ${{ matrix.php-version }}
          coverage: none
          extensions: simplexml
        env:
          phpts: ${{ matrix.php-thread-safe && 'ts' || 'nts' }}
          debug: true

      - name: Build librabbitmq
        run: ./infra/tools/pamqp-install-librabbitmq ${{ matrix.librabbitmq-version }}

      - name: Print librabbitmq version
        run: pkg-config librabbitmq --debug

      - name: Build PHP extension
        run: phpize && ./configure && make

      - name: Run minimal test suite
        run: make test | tee result-minimal.txt
        env:
          # Reset defaults to a) only run local tests, b) donâ€™t run memory checks as the full test suite run will do so
          TEST_PHP_ARGS: -j4
          PHP_AMQP_HOST: ""
          PHP_AMQP_SSL_HOST: ""

      - name: Test full test suite
        run: make test | tee result-full.txt

      - name: Benchmark PHP extension
        run: ./infra/tools/pamqp-php-cli-deterministic -d extension=modules/amqp.so benchmark.php

      - name: Dump report
        run: ./infra/tools/pamqp-test-report
