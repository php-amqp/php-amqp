name: Test

on:
    push:
    pull_request:
        types: [opened, synchronize, edited, reopened]

env:
    ACTIONS_ALLOW_UNSECURE_COMMANDS: true
    TEST_TIMEOUT: 120

jobs:
    checkstyle:
        name: Check coding style
        runs-on: ubuntu-22.04
        steps:
          - name: install clang-format
            uses: myci-actions/add-deb-repo@11
            with:
                repo: "deb https://apt.llvm.org/kinetic/ llvm-toolchain-kinetic main"
                repo-name: llvm
                keys-asc: https://apt.llvm.org/llvm-snapshot.gpg.key
          - name: Install
            run: sudo apt-get install clang-format-17
          - name: Check style
            run: clang-format-17 --dry-run --Werror  *.c *.h

    test:
        name: php-${{ matrix.php-version }} librabbitmq-${{ matrix.librabbitmq-version }} ${{ matrix.test-php-args == '-m' && 'memory leaks' || '' }}
        runs-on: ${{ matrix.os }}

        env:
            TEST_PHP_ARGS: ${{ matrix.test-php-args }}

        strategy:
            fail-fast: false
            matrix:
                include:
                    - php-version: '8.2'
                      librabbitmq-version: 'master'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '8.2'
                      librabbitmq-version: 'master'
                      test-php-args: '-m'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '8.2'
                      librabbitmq-version: 'v0.13.0'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '8.2'
                      librabbitmq-version: 'v0.11.0'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '8.2'
                      librabbitmq-version: 'v0.10.0'
                      experimental: false
                      os: ubuntu-20.04

                    - php-version: '8.1'
                      librabbitmq-version: 'master'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '8.1'
                      librabbitmq-version: 'master'
                      test-php-args: '-m'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '8.1'
                      librabbitmq-version: 'v0.13.0'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '8.1'
                      librabbitmq-version: 'v0.11.0'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '8.1'
                      librabbitmq-version: 'v0.10.0'
                      experimental: false
                      os: ubuntu-20.04

                    - php-version: '8.0'
                      librabbitmq-version: 'master'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '8.0'
                      librabbitmq-version: 'master'
                      test-php-args: '-m'
                      experimental: true
                      os: ubuntu-22.04
                    - php-version: '8.0'
                      librabbitmq-version: 'v0.13.0'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '8.0'
                      librabbitmq-version: 'v0.11.0'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '8.0'
                      librabbitmq-version: 'v0.10.0'
                      experimental: false
                      os: ubuntu-20.04

                    - php-version: '7.4'
                      librabbitmq-version: 'master'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '7.4'
                      librabbitmq-version: 'v0.13.0'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '7.4'
                      librabbitmq-version: 'v0.13.0'
                      test-php-args: '-m'
                      experimental: true
                      os: ubuntu-22.04
                    - php-version: '7.4'
                      librabbitmq-version: 'v0.11.0'
                      experimental: false
                      os: ubuntu-22.04
                    - php-version: '7.4'
                      librabbitmq-version: 'v0.10.0'
                      experimental: false
                      os: ubuntu-20.04

        services:
            rabbitmq:
                image: rabbitmq:3
                ports:
                    - 5671:5671
                    - 5672:5672
                    - 15671:15671
                    - 15672:15672

        steps:
            - name: Checkout
              uses: actions/checkout@v3.5.3

            - name: Install packages
              run: sudo apt-get install -y cmake valgrind

            - name: Setup PHP
              uses: shivammathur/setup-php@2.25.4
              with:
                  php-version: ${{ matrix.php-version }}
                  coverage: none

            - name: Build librabbitmq
              run: sudo ./provision/install_rabbitmq-c.sh ${{ matrix.librabbitmq-version }}

            - name: Debug librabbitmq
              run: pkg-config librabbitmq --debug

            - name: Build PHP extension
              env:
                CFLAGS: -D_FORTIFY_SOURCE=2 -fstack-protector-strong -Wall -Werror
              run: phpize && ./configure && make

            - name: Test PHP extension
              run: make test | tee result.txt

            - name: Benchmark PHP extension
              run: php -n -c './tmp-php.ini' -d "extension_dir=./modules/" -d "extension=amqp.so" benchmark.php

            - name: Dump report
              run: sh test-report.sh
              continue-on-error: ${{ matrix.experimental }}
